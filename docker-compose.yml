version: "3.8"

services:
  asterisk:
    image: call-center-asterisk-runtime:arm64
    container_name: asterisk
    hostname: asterisk
    volumes:
      - ./docker/asterisk/config:/etc/asterisk
      - asterisk_recordings:/var/spool/asterisk/monitor
      - asterisk_voicemail:/var/spool/asterisk/voicemail
      - asterisk_sounds:/var/lib/asterisk/sounds
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "10000-10100:10000-10100/udp"
      - "5038:5038"
      - "8088:8088"
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ASTERISK_PUBLIC_IP=${ASTERISK_PUBLIC_IP}
      - TWILIO_SIP_DOMAIN=${TWILIO_SIP_DOMAIN}
      - TWILIO_IPS=${TWILIO_IPS}
      - TWILIO_USERNAME=${TWILIO_USERNAME}
      - TWILIO_PASSWORD=${TWILIO_PASSWORD}
      - TWILIO_ORIGINATING_NUMBER=${TWILIO_ORIGINATING_NUMBER}
      - EXT_100_USERNAME=${EXT_100_USERNAME}
      - EXT_100_PASSWORD=${EXT_100_PASSWORD}
      - EXT_100_CALLERID=${EXT_100_CALLERID}
    networks:
      - call-center-network
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    networks:
      - call-center-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
      timeout: 20s
      retries: 10
      interval: 10s
    restart: unless-stopped

  adminer:
    image: adminer:latest
    container_name: adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
  
networks:
  call-center-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
        
volumes:
  mysql_data:
    driver: local
  asterisk_recordings:
    driver: local
  asterisk_voicemail:
    driver: local
  asterisk_sounds:
    driver: local